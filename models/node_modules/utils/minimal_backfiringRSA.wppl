var meaning = function(utt, effect){
		return utt=="It happened." ? effect :
				utt=="It did not happen." ? !effect:
				true
}


var listener0 = cache(function(utterance, habit, h_strength, a_strength) {
  Enumerate(function(){
    var behavior = habit ? flip(h_strength) : flip(a_strength)
    var m = meaning(utterance, behavior)
    condition(m)
    return behavior
  })
})

var speaker1 = cache(function(behavior, habit, h_strength, a_strength) {
  Enumerate(function(){
    var utterance = ["It happened.", 
                      "It did not happen.", 
                      "say nothing"][discrete([1,1,1])]
    var L0 = listener0(utterance, habit, h_strength, a_strength)
    factor(L0.score([],behavior))
    return utterance
  })
})

var listener1 = function(utterance, priorParameters, alpha) {
  Enumerate(function(){

	var prior = priorParameters.prior_probability_of_habit
	var h_strength = priorParameters.habit_strength
	var a_strength = priorParameters.alternative_strength

    var habit = flip(prior)
    var behavior = habit ? flip(h_strength) : flip(a_strength)

    var S1 = speaker1(behavior, habit, h_strength, a_strength)
    factor(alpha*S1.score([],utterance))
    return habit
  })
}

var nullListener0 = cache(function(utterance, prior, h_strength, a_strength) {
  Enumerate(function(){
    var habit = flip(prior)
    var behavior = habit ? flip(h_strength) : flip(a_strength)
    var m = meaning(utterance, behavior)
    condition(m)
    return behavior
  })
})

var nullSpeaker1 = cache(function(behavior, habit,  prior, h_strength, a_strength) {
  Enumerate(function(){
    var utterance = ["It happened.", 
                      "It did not happen.", 
                      "say nothing"][discrete([1,1,1])]
    var L0 = nullListener0(utterance, prior, h_strength, a_strength)
    factor(L0.score([],behavior))
    return utterance
  })
})

var nullListener1 = function(utterance, priorParameters, alpha) {
  Enumerate(function(){
	var prior = priorParameters.prior_probability_of_habit
	var h_strength = priorParameters.habit_strength
	var a_strength = priorParameters.alternative_strength

    var habit = flip(prior)
    var behavior = habit ? flip(h_strength) : flip(a_strength)
    var S1 = nullSpeaker1(behavior, habit, prior, h_strength, a_strength)
    factor(alpha*S1.score([],utterance))
    return habit
  })
}


var observation = cache(function(utterance, priorParameters) {
  Enumerate(function(){
	var prior = priorParameters.prior_probability_of_habit
	var h_strength = priorParameters.habit_strength
	var a_strength = priorParameters.alternative_strength
    var habit = flip(prior)
    var behavior = habit ? flip(h_strength) : flip(a_strength)
    var m = meaning(utterance, behavior)
    condition(m)
    return habit
  })
})


